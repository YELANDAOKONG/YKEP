# Protocol

此处是协议相关的文档。

---

## 数据格式

YKEP协议没有固定的数据格式。

---

# 网络

事件网络由服务组成。

服务由事件队列组成。

> 事件队列：不会存储数据的消息队列。

生产者：向事件队列发送事件消息的客户端。

消费者：接收事件消息的客户端。

**注意：事件队列不会存储任何数据，仅进行数据转发。**

用户名格式规范：由字母、数字、下划线组成，长度为4-20个字符；不能以下划线开头。

密码签名数据：

```
SHA512(
    <密码> + "%" + 取前8位(<13位时间戳>)
)
```

扩展数据：

任意Base64编码的数据。

## 握手

客户端握手包：

```
$YKEP#<协议版本号>@<客户端类型>&<扩展数据>
```

服务端握手包：

```
$YKEP#<协议版本号>@<服务端类型>&<扩展数据>
```

客户端主动连接到事件服务器时，首先发送客户端握手包；
服务端接收到握手包后，返回一个服务端握手包。

握手后进入登录阶段。

## 心跳

为保持TCP/IP连接，客户端和服务端需要定期发送心跳包。

心跳包：

```
%HEARTBEAT
```

心跳包不交换任何数据，仅用于保持TCP/IP连接。


## 登录

客户端连接到事件服务器后，需要进行登录。

> 在登录完成前，客户端不能执行任何操作。

客户端登录包：
```
$LOGIN#<用户名>*<密码签名数据>@<服务名>
```

服务端登录响应包：
```
$LOGIN#<登录状态码>&<扩展数据>
``````

客户端首先计算出当前时间段的密码签名数据，然后生成并发送登录包到服务端。

服务端接收到登录包后，检查相关数据，并返回登录状态码。

登录结果对当前TCP连接有效。

由于大部分物联网设备性能有限，因此协议暂时不支持通讯加密。

状态码：

```
200 登录成功
400 用户不存在
401 密码错误
403 拒绝登录
404 服务不存在
500 服务器内部错误
```

## 订阅

客户端登录成功后，可以订阅事件队列。

客户端订阅包：

```
$SUBSCRIBE#<事件队列名>&<扩展数据>
```

服务端订阅响应包：

```
$SUBSCRIBE#<订阅状态码>&<扩展数据>
```

客户端可以同时订阅多个事件队列。

订阅结果对当前TCP连接有效。

事件队列不需要创建，事件服务器会自动匹配相关生产者并转发数据。

状态码：
```
200 订阅成功
403 拒绝订阅
500 服务器内部错误
```

## 发布

客户端登录成功后，可以发布事件消息。

事件数据由Base64编码的数据组成。

事件数据可以是任何内容。

客户端发布包：

```
$PUBLISH#<事件队列名>@<事件数据>&<扩展数据>
```

服务端发布响应包：

```
$PUBLISH#<发布状态码>&<扩展数据>
```

状态码：
```
200 发布成功
403 拒绝发布
500 服务器内部错误
```

## 断开

客户端和服务端都可以主动断开连接。

通用断开连接包：
```
$DISCONNECT#<断开原因码>&<扩展数据>
```

状态码：
```
200 主动断开
400 异常断开
401 未登录
403 强制下线
500 内部错误
```

发送断开连接包后，客户端和服务端会立即断开连接。

服务端会自动清理相关客户端的订阅资源。


